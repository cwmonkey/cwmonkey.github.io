window.cwmForumUpdate=window.cwmForumUpdate||{},function(e,t){function a(e){var t=new Object;if(!e)return t;for(var a=e.split(/[;&]/),n=0;n<a.length;n++){var o=a[n].split("=");if(o&&2==o.length){var r=unescape(o[0]),s=unescape(o[1]);s=s.replace(/\+/g," "),t[r]=s}}return t}if(e.forumUpdate_running!=t)return void e.forumUpdate_running();var n=document.getElementsByTagName("script"),o=n[n.length-1],r=o.src.replace(/^[^\?]+\??/,""),s=a(r),l=function(e,a){var n=document.createElement("link");n.type="text/css",n.rel="stylesheet",n.href=e+(a!=t?"?"+(new Date).getTime():""),document.body.appendChild(n)};e.show_post_rate=1e3,e.min_post_age=0,e.cwmForumUpdate={load:function(){l(e.cwmBaseUrl+"/bookmarklets/forum-update/forum-update.css?2"),e.cwmForumUpdate.main=e.cwmForumUpdate.app},app:function(){var t=s.ref,a=200,n=5e3,o=5e3,r=200,l="#thread",u=".post",d='.pages.bottom a[title="Next page"]',f=[],c=!0,p=".postbuttons a",m='form[action="newreply.php"]',g=document.title,h=!1,v=0,w=$(l),_=w.find(u),b=_.length,T=$(d),C=$(e),x=$("body"),y=$(document);x.addClass("fuadded");var U,k,D=!1,F=!1;e.forumUpdate_running=function(){F=!F,F?(console.log("stopping all"),clearTimeout(k),clearTimeout(U)):(U=setTimeout(B,e.show_post_rate),q())};var j=function(e){return e=e.replace(/<script/gi,"<noscript").replace(/<\/script/gi,"</noscript").replace(/<((link)|(meta))/gi,"<br").replace(/<iframe/gi,"<xiframe").replace(/<\/iframe/gi,"</xiframe")};x.delegate(p,"click",function(e){e.preventDefault(),$.ajax(this.href,{}).done(function(e){e=j(e);var t=$("<div/>").html(e);delete e;var a=t.find(m);a.find("*:not(input, select, textarea):not(:has(input, select, textarea))").remove(),a.addClass("fureply"),w.append(a),a.bind("submit",function(e){e.preventDefault(),$.post(a.attr("action"),a.serialize()),a.hide()})})}).delegate(".fustar","click",function(e){e.preventDefault();var t=$(this),a=t.closest(u);a.is(".fustarred")?a.removeClass("fustarred"):a.addClass("fustarred")});var q=function(){t=t.split("#")[0],console.log("get_posts"),$.ajax(t,{}).done(function(e){e=j(e);var a=$("<div/>").html(e);delete e;var r=n;if(_=a.find(l).find(u),_.length>b){for(var s=_.slice(b),i=0,c=0;c<s.length;c++){var p=s[c],m=$(p);m.addClass("fupost"),m.fuurl=t,f.push(m),i++}r=o,console.log("get_posts got "+i+" posts")}T=a.find(d),T.length?(b=0,t=T.attr("href"),k=setTimeout(q,o)):(b=_.length,k=setTimeout(q,r)),a.remove()}).fail(function(){k=setTimeout(q,rate)})},B=function(){if(console.log("show_post"),U=setTimeout(B,e.show_post_rate),f.length){var t=w.find(u);if(t.length>=a)for(i=0;i<=t.length-a;i++){var n=C.scrollTop(),o=t.eq(i),s=o.outerHeight(!0);o.is(".fustarred")||o.remove(),E=!1,C.scrollTop(n-s),E=!0}var o=f[0],l=o.find(".postdate").clone();l.find("a").remove(),postdate=new Date(new Date(l.text().trim())-252e5);var d=new Date-postdate;o.find(".author").prepend($("<span>"+d/1e3+" </span>")),o.find("a").attr("target","_blank"),f.shift();var c=$('<a href="#">&#9733;</a>').addClass("fustar");o.append(c),o.addClass("funew"),-1!==o.text().indexOf("WrasslorMonkey")&&o.find(".postbody").addClass("userquoted"),w.append(o),h&&(v++,document.title="("+v+") "+g),D||(E=!1,C.scrollTo(o,r,{axis:"y",onAfter:function(){E=!0}})),document.location.href!=o.fuurl&&history.pushState(null,null,o.fuurl),setTimeout(function(){o.removeClass("funew")},0)}};T.length&&(t=T.attr("href"),b=0);var E=!0;C.bind("scroll",function(){E&&(E=!1,C.scrollTop()>=y.height()-C.height()?(D=!1,console.log("restarting")):(D=!0,console.log("suspending")),E=!0)}).bind("blur",function(){h=!0;var e=w.find(u);e.removeClass("fulast"),e.last().addClass("fulast")}).bind("focus",function(){h=!1,v=0,document.title=g}),U=setTimeout(B,e.show_post_rate),c&&x.delegate("a","mouseover focus",function(){this.target="comment_window"}),_.each(function(){var e=$(this).addClass("fupost"),t=$('<a href="#">&#9733;</a>').addClass("fustar");e.append(t)}),q()}}}(window);