window.cwmForumUpdate=window.cwmForumUpdate||{},function(e,t){function a(e){var t=new Object;if(!e)return t;for(var a=e.split(/[;&]/),n=0;n<a.length;n++){var r=a[n].split("=");if(r&&2==r.length){var o=unescape(r[0]),i=unescape(r[1]);i=i.replace(/\+/g," "),t[o]=i}}return t}if(e.forumUpdate_running!=t)return void e.forumUpdate_running();var n=document.getElementsByTagName("script"),r=n[n.length-1],o=r.src.replace(/^[^\?]+\??/,""),s=a(o),u=function(e,a){var n=document.createElement("link");n.type="text/css",n.rel="stylesheet",n.href=e+(a!=t?"?"+(new Date).getTime():""),document.body.appendChild(n)};e.show_post_rate=1e3,e.min_post_age=0,e.cwmForumUpdate={load:function(){u(e.cwmBaseUrl+"/bookmarklets/forum-update/forum-update.css?2"),e.cwmForumUpdate.main=e.cwmForumUpdate.app},app:function(){var t=s.ref,a=200,n=5e3,r=5e3,o=200,u="#thread",l=".post",d='.pages.bottom a[title="Next page"]',f=[],c=!0,p=".postbuttons a",m='form[action="newreply.php"]',h=document.title,v=!1,g=0,w=$(u),T=w.find(l),b=T.length,_=$(d),C=$(e),x=$("body"),y=$(document);x.addClass("fuadded");var U,k,D=!1,F=!1;e.forumUpdate_running=function(){F=!F,F?(clearTimeout(k),clearTimeout(U)):(U=setTimeout(B,e.show_post_rate),q())};var j=function(e){return e=e.replace(/<script/gi,"<noscript").replace(/<\/script/gi,"</noscript").replace(/<((link)|(meta))/gi,"<br").replace(/<iframe/gi,"<xiframe").replace(/<\/iframe/gi,"</xiframe")};x.delegate(p,"click",function(e){e.preventDefault(),$.ajax(this.href,{}).done(function(e){e=j(e);var t=$("<div/>").html(e);delete e;var a=t.find(m);a.find("*:not(input, select, textarea):not(:has(input, select, textarea))").remove(),a.addClass("fureply"),w.append(a),a.bind("submit",function(e){e.preventDefault(),$.post(a.attr("action"),a.serialize()),a.hide()})})}).delegate(".fustar","click",function(e){e.preventDefault();var t=$(this),a=t.closest(l);a.is(".fustarred")?a.removeClass("fustarred"):a.addClass("fustarred")});var q=function(){t=t.split("#")[0],$.ajax(t,{}).done(function(e){e=j(e);var a=$("<div/>").html(e);delete e;var o=n;if(T=a.find(u).find(l),T.length>b){for(var i=T.slice(b),s=0,c=0;c<i.length;c++){var p=i[c],m=$(p);m.addClass("fupost"),m.fuurl=t,f.push(m),s++}o=r}_=a.find(d),_.length?(b=0,t=_.attr("href"),k=setTimeout(q,r)):(b=T.length,k=setTimeout(q,o)),a.remove()}).fail(function(){k=setTimeout(q,rate)})},B=function(){if(U=setTimeout(B,e.show_post_rate),f.length){var t=w.find(l);if(t.length>=a)for(i=0;i<=t.length-a;i++){var n=C.scrollTop(),r=t.eq(i),s=r.outerHeight(!0);r.is(".fustarred")||r.remove(),E=!1,C.scrollTop(n-s),E=!0}var r=f[0],u=r.find(".postdate").clone();u.find("a").remove(),postdate=new Date(new Date(u.text().trim())-252e5);var d=new Date-postdate;r.find(".author").prepend($("<span>"+d/1e3+" </span>")),r.find("a").attr("target","_blank"),f.shift();var c=$('<a href="#">&#9733;</a>').addClass("fustar");r.append(c),r.addClass("funew"),-1!==r.text().indexOf("WrasslorMonkey")&&r.find(".postbody").addClass("userquoted"),w.append(r),v&&(g++,document.title="("+g+") "+h),D||(E=!1,console.log("scrolling"),setTimeout(function(){C.scrollTo(r,o,{axis:"y",onAfter:function(){E=!0}})},10)),document.location.href!=r.fuurl&&history.pushState(null,null,r.fuurl),setTimeout(function(){r.removeClass("funew")},0)}};_.length&&(t=_.attr("href"),b=0);var E=!0;C.bind("scroll",function(){E&&(E=!1,D=C.scrollTop()>=y.height()-C.height()?!1:!0,E=!0)}).bind("blur",function(){v=!0;var e=w.find(l);e.removeClass("fulast"),e.last().addClass("fulast")}).bind("focus",function(){v=!1,g=0,document.title=h}),U=setTimeout(B,e.show_post_rate),c&&x.delegate("a","mouseover focus",function(){this.target="comment_window"}),T.each(function(){var e=$(this).addClass("fupost"),t=$('<a href="#">&#9733;</a>').addClass("fustar");e.append(t)}),q()}}}(window);