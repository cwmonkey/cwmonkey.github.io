!function(t){var e,i,o=!1,s=function(t,e,i,s,n){o&&console.log("Note"),this.frame=n,this.save_fn=s,this.note_form_tpl=i,this.note_tpl=e,this.init(t)};s.prototype.init=function(i){o&&console.log("Note.init");var s=this;this.editing=!1,this.attrs=[{p:"title",s:"t"},{p:"body",s:"b"},{p:"match",s:"m"},{p:"collapsed",s:"c"},{p:"absolute",s:"a"},{p:"zindex",s:"z"},{p:"x",s:"x"},{p:"y",s:"y"},{p:"width",s:"w"},{p:"height",s:"h"},{p:"out",s:"o"},{p:"deleted",s:"d"},{p:"updated",s:"u"}],this.attrs.forEach(function(e){s[e.p]=i[e.p]||i[e.s]||t}),this.id=i.id,this.id||(this.id=Date.now().toString(36),this.save_fn&&this.save_fn(this.id,this.export())),this.marked_body=marked(this.body),this.$el=e(this.note_tpl(this).trim()),this.$el.data("__make-note-object",this)},s.prototype.update=function(t,e){o&&console.log("Note.update"),this[t]!==e&&(this[t]=e,this.updated=Date.now().toString(36),this.save_fn&&this.save_fn(this.id,this.export()))},s.prototype.matches=function(t){return o&&console.log("Note.matches"),h.fauxMatch(this.match,t)},s.prototype.minimize=function(){o&&console.log("Note.minimize"),this.$el.addClass("__make-note--minimized"),this.update("collapsed",1)},s.prototype.restore=function(){o&&console.log("Note.restore"),this.$el.removeClass("__make-note--minimized"),this.update("collapsed",t)},s.prototype.edit=function(){o&&console.log("Note.edit"),this.editing=!0,this.$el.addClass("__make-note--editing").append(this.note_form_tpl(this))},s.prototype.save=function(e,i,s){o&&console.log("Note.save"),this.editing=!1;var n=this,a=!1;e.forEach(function(e){var i=e.value||t;i!==n[e.name]&&(n[e.name]=i,a=!0)}),a&&!s&&(this.updated=Date.now().toString(36),this.save_fn(this.id,this.export())),this.$el.removeClass("__make-note--editing").find(".__make-note--form").remove().end().find(".__make-note--mover").html(this.title).end().find(".__make-note--match").html(this.match).end().find(".__make-note--body").html(marked(this.body)).end().css({width:this.width,height:this.height,top:this.y,left:this.x,zIndex:this.zindex});var h=this.matches(i);this.out&&h?this.toWindow():h&&this.toList(),this.deleted&&this.del(),this.collapsed?this.minimize():this.restore(),this.absolute?this.$el.addClass("__make-note--absoluted"):this.$el.removeClass("__make-note--absoluted")},s.prototype.cancel=function(){o&&console.log("Note.cancel"),this.editing=!1,this.$el.css({width:this.width,height:this.height,top:this.y,left:this.x,zIndex:this.zindex}).removeClass("__make-note--editing").find(".__make-note--form").remove()},s.prototype.del=function(){if(o&&console.log("Note.del"),confirm("Wanna delete?")){var e=[];return this.attrs.forEach(function(i){e.push({name:i.p,value:t})}),this.save(e,null,!0),this.update("deleted",1),this.frame.postMessage({type:"delete",id:this.id},"*"),!0}return!1},s.prototype.toWindow=function(){o&&console.log("Note.toWindow"),this.update("out",1),this.frame.postMessage({type:"toWindow",id:this.id,note:this.export()},"*"),this.$el.addClass("to-window")},s.prototype.toList=function(){o&&console.log("Note.toList"),this.update("out",t),this.frame.postMessage({type:"toList",id:this.id},"*"),this.$el.removeClass("to-window")},s.prototype.export=function(){o&&console.log("Note.export");var e={},i=this;return this.attrs.forEach(function(o){i[o.p]!==t&&(e[o.s]=i[o.p])}),e};var n,a=function(t){clearTimeout(n),n=setTimeout(function(){var i=e(t),o=t.style.width;t.style.cssText="height:auto;"+(o?"width:"+o:"");var s=i.outerHeight(!0);t.style.cssText="padding-top:0; padding-bottom:0; border-top:0; border-bottom:0;"+(o?"width:"+o:"");var n=s-i.outerHeight(!0);t.style.cssText="height:"+(t.scrollHeight+n)+"px;"+(o?"width:"+o:""),i.trigger("autosize")},0)},h=window.cwmMakeNote={get_node:function(t){return e(t).closest(".__make-note--note").data("__make-note-object")},wnotes:{},notes:{},fauxMatch:function(t,e){t=t.replace(/([\.\\\+\?\[\^\]\$\(\)\{\}\=\!\>\|\:\-])/g,"\\$1").replace(/\*/g,".*").replace(/\/\.\*$/,"(\\/.*)?")+"(#.*)?";var i=new RegExp(t);return e.match(i)}};window.cwmMakeNote.Note=s;var d=window.cwmMakeNoteApp=function(t,s,n){n&&(o=!0),e=t,i=s,e.fn.serializeObject=function(){var t={};return this.serializeArray().forEach(function(e){t[e.name]=e.value}),t}};d.prototype.tpl=function(t){var e=i.compile(t);return e},d.prototype.attach=function(){e(document).delegate('[data-type="min"]',"click",function(){h.get_node(this).minimize()}).delegate('[data-type="restore"]',"click",function(){h.get_node(this).restore()}).delegate(".__make-note--note textarea","input drop paste cut delete click",function(){a(this)}).delegate('[data-type="edit"]',"click",function(){var t=h.get_node(this);t.edit(),a(t.$el.find("textarea")[0])}).delegate('[data-type="save"]',"click",function(t){t.preventDefault(),h.get_node(this).save(e(this).closest("form").serializeArray())}).delegate('[data-type="cancel"]',"click",function(t){t.preventDefault(),h.get_node(this).cancel()}).delegate('[data-type="delete"]',"click",function(t){t.preventDefault();var e=h.get_node(this);e.del()&&(e.$el.remove(),delete h.notes[e.id])})}}();