!function(undefined){var $,debug=!1,Note=function(e,t,i,o,n){debug&&console.log("Note"),this.frame=n,this.save_fn=o,this.note_form_tpl=i,this.note_tpl=t,this.init(e)};Note.prototype.init=function(e){debug&&console.log("Note.init");var t=this;this.editing=!1,this.attrs=[{p:"title",s:"t"},{p:"body",s:"b"},{p:"match",s:"m"},{p:"collapsed",s:"c"},{p:"absolute",s:"a"},{p:"zindex",s:"z"},{p:"x",s:"x"},{p:"y",s:"y"},{p:"width",s:"w"},{p:"height",s:"h"},{p:"out",s:"o"},{p:"deleted",s:"d"},{p:"updated",s:"u"}],this.attrs.forEach(function(i){t[i.p]=e[i.p]||e[i.s]||undefined}),this.id=e.id,this.id||(this.id=Date.now().toString(36),this.save_fn&&this.save_fn(this.id,this.export())),this.marked_body=marked(this.body),this.$el=$(this.note_tpl(this).trim()),this.$el.data("__make-note-object",this)},Note.prototype.update=function(e,t){debug&&console.log("Note.update"),this[e]!==t&&(this[e]=t,this.updated=Date.now().toString(36),this.save_fn&&this.save_fn(this.id,this.export()))},Note.prototype.matches=function(e){return debug&&console.log("Note.matches"),cwmMakeNote.fauxMatch(this.match,e)},Note.prototype.minimize=function(){debug&&console.log("Note.minimize"),this.$el.addClass("__make-note--minimized"),this.update("collapsed",1)},Note.prototype.restore=function(){debug&&console.log("Note.restore"),this.$el.removeClass("__make-note--minimized"),this.update("collapsed",undefined)},Note.prototype.edit=function(){debug&&console.log("Note.edit"),this.editing=!0,this.$el.addClass("__make-note--editing").append(this.note_form_tpl(this))},Note.prototype.save=function(e,t,i){debug&&console.log("Note.save"),this.editing=!1;var o=this,n=!1;e.forEach(function(e){var t=e.value||undefined;t!==o[e.name]&&(o[e.name]=t,n=!0)}),n&&!i&&(this.updated=Date.now().toString(36),this.save_fn(this.id,this.export())),this.$el.removeClass("__make-note--editing").find(".__make-note--form").remove().end().find(".__make-note--mover").html(this.title).end().find(".__make-note--match").html(this.match).end().find(".__make-note--body").html(marked(this.body)).end().css({width:this.width,height:this.height,top:this.y,left:this.x,zIndex:this.zindex});var s=this.matches(t);this.out&&s?this.toWindow():s&&this.toList(),this.deleted&&this.del(),this.collapsed?this.minimize():this.restore(),this.absolute?this.$el.addClass("__make-note--absoluted"):this.$el.removeClass("__make-note--absoluted")},Note.prototype.cancel=function(){debug&&console.log("Note.cancel"),this.editing=!1,this.$el.css({width:this.width,height:this.height,top:this.y,left:this.x,zIndex:this.zindex}).removeClass("__make-note--editing").find(".__make-note--form").remove()},Note.prototype.del=function(){if(debug&&console.log("Note.del"),confirm("Wanna delete?")){var e=[];return this.attrs.forEach(function(t){e.push({name:t.p,value:undefined})}),this.save(e,null,!0),this.update("deleted",1),this.frame.postMessage({type:"delete",id:this.id},"*"),!0}return!1},Note.prototype.toWindow=function(){debug&&console.log("Note.toWindow"),this.update("out",1),this.frame.postMessage({type:"toWindow",id:this.id,note:this.export()},"*"),this.$el.addClass("to-window")},Note.prototype.toList=function(){debug&&console.log("Note.toList"),this.update("out",undefined),this.frame.postMessage({type:"toList",id:this.id},"*"),this.$el.removeClass("to-window")},Note.prototype.export=function(){debug&&console.log("Note.export");var e={},t=this;return this.attrs.forEach(function(i){t[i.p]!==undefined&&(e[i.s]=t[i.p])}),e};var autosize_to,autosize=function(e){clearTimeout(autosize_to),autosize_to=setTimeout(function(){var t=$(e),i=e.style.width;e.style.cssText="height:auto;"+(i?"width:"+i:"");var o=t.outerHeight(!0);e.style.cssText="padding-top:0; padding-bottom:0; border-top:0; border-bottom:0;"+(i?"width:"+i:"");var n=o-t.outerHeight(!0);e.style.cssText="height:"+(e.scrollHeight+n)+"px;"+(i?"width:"+i:""),t.trigger("autosize")},0)},if_reg=/\{\{ *#if +([a-z_][a-z_0-9A-Z]*) *\}\}/g,else_reg=/\{\{ *else *\}\}/g,endif_reg=/\{\{ *\/if *\}\}/g,each_reg=/\{\{ *#each +([a-z_][a-z_0-9A-Z]*) *\}\}/g,endeach_reg=/\{\{ *\/each *\}\}/g,trim_reg=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,n_reg=/\n/g,this_reg=/\{\{ *this *\}\}/g,var_raw_reg=/\{\{\{ *([a-z_][a-z_0-9A-Z]*) *\}\}\}/g,var_reg=/\{\{ *([a-z_][a-z_0-9A-Z]*) *\}\}/g,cwmMakeNote=window.cwmMakeNote={get_node:function(e){return $(e).closest(".__make-note--note").data("__make-note-object")},wnotes:{},notes:{},fauxMatch:function(e,t){e=e.replace(/([\.\\\+\?\[\^\]\$\(\)\{\}\=\!\>\|\:\-])/g,"\\$1").replace(/\*/g,".*").replace(/\/\.\*$/,"(\\/.*)?").replace(/\/$/,"\\/?")+"(#.*)?";var i=new RegExp(e);return t.match(i)},compile:function(html){var fn="function(d,undefined){var html='";return fn+=html.replace(trim_reg,"").replace(n_reg,"\\\n").replace(if_reg,"';if (d.$1) {html+='").replace(else_reg,"';}else{html+='").replace(endif_reg,"';}html+='").replace(each_reg,"';for(var i=0,l=d.$1.length,v;i<l;i++){v=d.$1[i];html+='").replace(endeach_reg,"';};html+='").replace(this_reg,"';html+=v;html+='").replace(var_raw_reg,"';if(d.$1!==undefined){html+=d.$1};html+='").replace(var_reg,"';if(d.$1!==undefined){html+=d.$1};html+='"),fn+="';return html}",eval("var func = "+fn),func}};window.cwmMakeNote.Note=Note;var cwmMakeNoteApp=window.cwmMakeNoteApp=function(e,t){t&&(debug=!0),$=e,$.fn.serializeObject=function(){var e={};return this.serializeArray().forEach(function(t){e[t.name]=t.value}),e}};cwmMakeNoteApp.prototype.tpl=function(e){var t=cwmMakeNote.compile(e);return t},cwmMakeNoteApp.prototype.attach=function(){$(document).delegate('[data-type="min"]',"click",function(){cwmMakeNote.get_node(this).minimize()}).delegate('[data-type="restore"]',"click",function(){cwmMakeNote.get_node(this).restore()}).delegate(".__make-note--note textarea","input drop paste cut delete click",function(){autosize(this)}).delegate('[data-type="edit"]',"click",function(){var e=cwmMakeNote.get_node(this);e.edit(),autosize(e.$el.find("textarea")[0])}).delegate('[data-type="save"]',"click",function(e){e.preventDefault(),cwmMakeNote.get_node(this).save($(this).closest("form").serializeArray())}).delegate('[data-type="cancel"]',"click",function(e){e.preventDefault(),cwmMakeNote.get_node(this).cancel()}).delegate('[data-type="delete"]',"click",function(e){e.preventDefault();var t=cwmMakeNote.get_node(this);t.del()&&(t.$el.remove(),delete cwmMakeNote.notes[t.id])})}}();