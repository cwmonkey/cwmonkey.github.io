!function(){var e,t=!1;window.cwmMakeNote.load=function(n,a,i){e=a,t=i,n.cwmMakeNote.main=o};var o=function(){function t(e){var t=e.changedTouches[0],o=document.createEvent("MouseEvent");o.initMouseEvent({touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"}[e.type],!0,!0,window,1,t.screenX,t.screenY,t.clientX,t.clientY,!1,!1,!1,!1,0,null),t.target.dispatchEvent(o),e.preventDefault()}var o={},n=new window.cwmMakeNoteApp(e);n.attach();var a=function(e,t){c.contentWindow.postMessage({type:"save_note",id:e,note:t},"*")},i=function(e){if("string"!=typeof e.data&&console.log("main",e.data),e.origin==document.location.protocol+"//{{ site.domain }}")if("loaded"===e.data.type)s.addClass("__make-note_loaded").attr("scrolling","yes"),e.data.tpls.forEach(function(e){o[e.name]=n.tpl(e.html)});else if("destroy"===e.data.type)s.remove();else if("open"===e.data.type)s.addClass("__make-note_opened"),s[0].scrolling="auto",s.attr({scrolling:"auto"});else if("close"===e.data.type)s.removeClass("__make-note_opened"),s[0].scrolling="no",s.attr({scrolling:"no"});else if("toWindow"===e.data.type){cwmMakeNote.notes[e.data.id]&&(cwmMakeNote.notes[e.data.id].$el.remove(),delete cwmMakeNote.notes[e.data.id]),e.data.note.id=e.data.id;var t=new window.cwmMakeNote.Note(e.data.note,o["note-tpl"],o["note-form-tpl"],a,c.contentWindow);t.$el.appendTo(document.body),cwmMakeNote.notes[e.data.id]=t}else"toList"===e.data.type&&cwmMakeNote.notes[e.data.id]?(cwmMakeNote.notes[e.data.id].$el.remove(),delete cwmMakeNote.notes[e.data.id]):"delete"===e.data.type&&cwmMakeNote.notes[e.data.id]&&(cwmMakeNote.notes[e.data.id].$el.remove(),delete cwmMakeNote.notes[e.data.id])};window.addEventListener("message",i,!1);var d=e('<link rel="stylesheet" id="__make-note-css"/>');d.attr({href:"//{{ site.domain }}/css/make-note.css"}),d.appendTo(document.head);var s=e('<iframe id="__make-note" scrolling="no" style="display: none; opacity: 0"></iframe>'),c=s[0];s.attr({src:"//{{ site.domain }}/greasemonkey/make-note/make-note-iframe.html#"+document.location.href}),s.appendTo(document.body),setTimeout(function(){s.addClass("__make-note_opened"),s[0].scrolling="auto",s.attr({scrolling:"auto"}),setTimeout(function(){s.removeClass("__make-note_opened"),s[0].scrolling="no",s.attr({scrolling:"no"})},0)},0),function(e){for(var t,o=function(e){var t;document.createEvent?(t=document.createEvent("HTMLEvents"),t.initEvent(e,!0,!0)):(t=document.createEventObject(),t.eventType=e),t.eventName=e,document.createEvent?window.dispatchEvent(t):window.fireEvent("on"+t.eventType,t)},n={},a=["pushState","replaceState"],i=0,d=a.length;d>i;i++)t=a[i],n[t]=e[t],e[t]=function(t){return function(){var a=n[t].apply(e,arguments);return o(t.toLowerCase()),a}}(t)}(window.history);var l=function(){c.contentWindow.postMessage({type:"url_change",url:document.location.href},"*")};window.addEventListener("popstate",l),window.addEventListener("pushstate",l),window.addEventListener("replacestate",l);var m,u,r,v,p,h,w,f,g,k,y,_,M,E,N=e(window),b=e(document.body),L=0,C=0,T=0,x=0,$=0,W=0,X=0,Y=0,H=function(){0>=x&&(x=0),p.absolute||(g=N.height(),k=r.outerHeight(!0),k>g&&(r.css({height:g}),m=g),x+k>g&&(x=g-k)),0>=T&&(T=0),p.absolute||(_=N.width(),M=r.outerWidth(!0),M>_&&(r.css({width:_}),u=_),T+M>_&&(T=_-M))},I=function(e){x=e.clientY-C,T=e.clientX-L,H(),v.style.top=x+"px",v.style.left=T+"px"},S=function(e){Y=e.clientY-W,f.absolute||(g=N.height(),y=parseInt(h.css("top")),y+Y>g&&(Y=g-y)),w.style.height=Y+"px",X=e.clientX-$,f.absolute||(_=N.width(),E=parseInt(h.css("left")),E+X>_&&(X=_-E)),w.style.width=X+"px"},j=function(){H();var e=p;N.unbind("mousemove",I),b.removeClass("__make-note--moving").unbind("mouseup mouseleave",j),e.editing||(0>=T?(e.x=void 0,v.style.left="0"):e.x=T,0>=x?(e.y=void 0,v.style.top="0"):e.y=x,u&&(e.width=u),m&&(e.height=m),a(e.id,e.export()))},z=function(){var e=cwmMakeNote.get_node(w);N.unbind("mousemove",S),b.unbind("mouseup mouseleave",z),e.editing||(0>=X?(e.width=void 0,v.style.left="0"):e.width=X,0>=Y?(e.height=void 0,v.style.height="0"):e.height=Y,a(e.id,e.export()))};e(document).delegate(".__make-note--note","focusin",function(){e(this).addClass("__make-note--focused")}).delegate(".__make-note--note","focusout",function(){e(this).removeClass("__make-note--focused")}).delegate('[data-type="mover"]',"mousedown",function(e){1===event.which&&(p=cwmMakeNote.get_node(this),r=p.$el,v=r[0],L=e.clientX-v.offsetLeft,C=e.clientY-v.offsetTop,m=void 0,N.bind("mousemove",I),b.addClass("__make-note--moving").bind("mouseup mouseleave",j))}).delegate('[data-type="resize"]',"mousedown",function(e){1===event.which&&(f=cwmMakeNote.get_node(this),h=f.$el,w=h[0],$=e.clientX-h.outerWidth(!0),W=e.clientY-h.outerHeight(!0),N.bind("mousemove",S),b.bind("mouseup mouseleave",z))}).delegate('[data-type="to-list"]',"click",function(){cwmMakeNote.get_node(this).toList(),cwmMakeNote.get_node(this).$el.remove()}),document.addEventListener("touchstart",t,!0),document.addEventListener("touchmove",t,!0),document.addEventListener("touchend",t,!0),document.addEventListener("touchcancel",t,!0)}}();