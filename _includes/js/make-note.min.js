!function(){var e,t=!1;window.cwmMakeNote.load=function(n,a,i){e=a,t=i,n.cwmMakeNote.main=o};var o=function(){var t={},o=new window.cwmMakeNoteApp(e);o.attach();var n=function(e,t){s.contentWindow.postMessage({type:"save_note",id:e,note:t},"*")},a=function(e){if("string"!=typeof e.data&&console.log("main",e.data),e.origin==document.location.protocol+"//{{ site.domain }}")if("loaded"===e.data.type)d.addClass("__make-note_loaded").attr("scrolling","yes"),e.data.tpls.forEach(function(e){t[e.name]=o.tpl(e.html)});else if("destroy"===e.data.type)d.remove();else if("open"===e.data.type)d.addClass("__make-note_opened"),d[0].scrolling="auto",d.attr({scrolling:"auto"});else if("close"===e.data.type)d.removeClass("__make-note_opened"),d[0].scrolling="no",d.attr({scrolling:"no"});else if("toWindow"===e.data.type){cwmMakeNote.notes[e.data.id]&&(cwmMakeNote.notes[e.data.id].$el.remove(),delete cwmMakeNote.notes[e.data.id]),e.data.note.id=e.data.id;var a=new window.cwmMakeNote.Note(e.data.note,t["note-tpl"],t["note-form-tpl"],n,s.contentWindow);a.$el.appendTo(document.body),cwmMakeNote.notes[e.data.id]=a}else"toList"===e.data.type&&cwmMakeNote.notes[e.data.id]?(cwmMakeNote.notes[e.data.id].$el.remove(),delete cwmMakeNote.notes[e.data.id]):"delete"===e.data.type&&cwmMakeNote.notes[e.data.id]&&(cwmMakeNote.notes[e.data.id].$el.remove(),delete cwmMakeNote.notes[e.data.id])};window.addEventListener("message",a,!1);var i=e('<link rel="stylesheet" id="__make-note-css"/>');i.attr({href:"//{{ site.domain }}/css/make-note.css"}),i.appendTo(document.head);var d=e('<iframe id="__make-note" scrolling="no" style="display: none; opacity: 0"></iframe>'),s=d[0];d.attr({src:"//{{ site.domain }}/greasemonkey/make-note/make-note-iframe.html#"+document.location.href}),d.appendTo(document.body),function(e){for(var t,o=function(e){var t;document.createEvent?(t=document.createEvent("HTMLEvents"),t.initEvent(e,!0,!0)):(t=document.createEventObject(),t.eventType=e),t.eventName=e,document.createEvent?window.dispatchEvent(t):window.fireEvent("on"+t.eventType,t)},n={},a=["pushState","replaceState"],i=0,d=a.length;d>i;i++)t=a[i],n[t]=e[t],e[t]=function(t){return function(){var a=n[t].apply(e,arguments);return o(t.toLowerCase()),a}}(t)}(window.history);var c=function(){s.contentWindow.postMessage({type:"url_change",url:document.location.href},"*")};window.addEventListener("popstate",c),window.addEventListener("pushstate",c),window.addEventListener("replacestate",c);var l,m,r,u,p,w,v,h,f,g,y,k,_,M,N=e(window),b=e(document.body),E=0,L=0,x=0,C=0,T=0,$=0,W=0,X=0,Y=function(){0>=C&&(C=0),p.absolute||(f=N.height(),g=r.outerHeight(!0),g>f&&(r.css({height:f}),l=f),C+g>f&&(C=f-g)),0>=x&&(x=0),p.absolute||(k=N.width(),_=r.outerWidth(!0),_>k&&(r.css({width:k}),m=k),x+_>k&&(x=k-_))},H=function(e){C=e.clientY-L,x=e.clientX-E,Y(),u.style.top=C+"px",u.style.left=x+"px"},I=function(e){X=e.clientY-$,h.absolute||(f=N.height(),y=parseInt(w.css("top")),y+X>f&&(X=f-y)),v.style.height=X+"px",W=e.clientX-T,h.absolute||(k=N.width(),M=parseInt(w.css("left")),M+W>k&&(W=k-M)),v.style.width=W+"px"},S=function(){Y();var e=p;N.unbind("mousemove",H),b.removeClass("__make-note--moving").unbind("mouseup mouseleave",S),e.editing||(0>=x?(e.x=void 0,u.style.left="0"):e.x=x,0>=C?(e.y=void 0,u.style.top="0"):e.y=C,m&&(e.width=m),l&&(e.height=l),n(e.id,e.export()))},j=function(){var e=cwmMakeNote.get_node(v);N.unbind("mousemove",I),b.unbind("mouseup mouseleave",j),e.editing||(0>=W?(e.width=void 0,u.style.left="0"):e.width=W,0>=X?(e.height=void 0,u.style.height="0"):e.height=X,n(e.id,e.export()))};e(document).delegate(".__make-note--note","focusin",function(){e(this).addClass("__make-note--focused")}).delegate(".__make-note--note","focusout",function(){e(this).removeClass("__make-note--focused")}).delegate('[data-type="mover"]',"mousedown",function(e){1===event.which&&(p=cwmMakeNote.get_node(this),r=p.$el,u=r[0],E=e.clientX-u.offsetLeft,L=e.clientY-u.offsetTop,l=void 0,N.bind("mousemove",H),b.addClass("__make-note--moving").bind("mouseup mouseleave",S))}).delegate('[data-type="resize"]',"mousedown",function(e){1===event.which&&(h=cwmMakeNote.get_node(this),w=h.$el,v=w[0],T=e.clientX-w.outerWidth(!0),$=e.clientY-w.outerHeight(!0),N.bind("mousemove",I),b.bind("mouseup mouseleave",j))}).delegate('[data-type="to-list"]',"click",function(){cwmMakeNote.get_node(this).toList(),cwmMakeNote.get_node(this).$el.remove()})}}();